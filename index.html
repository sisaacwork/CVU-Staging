<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>CVU Partnerships Journey</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --cvu-bg:#171717;      /* background */
      --cvu-text:#FCFCFC;    /* primary text / white */
      --cvu-accent:#B4EB17;  /* accent */
      --cvu-muted:#9EA3A9;   /* subtle text */
      --cvu-card:#1f1f1f;    /* card bg */
      --cvu-card-2:#232323;  /* alt card bg */
      --radius:16px;
      --radius-lg:20px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --maxw:1200px;
      --ribbon-h:64px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:var(--cvu-bg); color:var(--cvu-text); line-height:1.5;
    }
    a{color:inherit; text-decoration:none}
    .container{max-width:var(--maxw); margin-inline:auto; padding:0 20px}

    /* Hero */
    .hero{padding:64px 0 24px}
    .eyebrow{color:var(--cvu-accent); font-weight:600; letter-spacing:.08em; text-transform:uppercase; font-size:.85rem}
    h1{margin:.35rem 0 1rem; font-size:clamp(28px,3.5vw,44px); line-height:1.15}
    .lead{color:var(--cvu-muted); max-width:65ch; font-size:1.05rem}

    /* Sticky ecosystem ribbon */
    .ecosystem{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(180deg, #191919 0%, #111 100%);
      box-shadow:0 4px 14px rgba(0,0,0,.35);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .eco-steps{display:flex; gap:10px; align-items:center; padding:12px 0; overflow:auto}
    .eco-step{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px; background:#111; border:1px solid rgba(255,255,255,.06);
      border-radius:999px; white-space:nowrap; font-weight:600; font-size:.95rem;
      transition:transform .15s ease, background .2s ease, border-color .2s ease;
    }
    .eco-step span.num{
      display:inline-grid; place-items:center; width:26px; height:26px; border-radius:50%;
      background:var(--cvu-card-2); font-weight:700; font-size:.85rem;
    }
    .eco-step:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.16)}
    .eco-step.active{background:var(--cvu-accent); color:#111; border-color:transparent}
    .eco-step.active span.num{background:#111; color:var(--cvu-accent)}

    /* Sections */
    section.stage{scroll-margin-top:calc(var(--ribbon-h) + 16px); padding:48px 0}
    .stage-grid{
      display:grid; grid-template-columns:1.2fr .8fr; gap:28px; align-items:start;
    }
    .stage h2{margin:0 0 .25rem; font-size:clamp(22px,2.5vw,30px)}
    .subtitle{color:var(--cvu-muted); margin:0 0 1rem}
    .card{
      background:var(--cvu-card); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius);
      padding:18px; box-shadow:var(--shadow);
    }
    .img-wrap{
      border-radius:var(--radius); overflow:hidden; border:1px solid rgba(255,255,255,.06);
      background:#0f0f0f;
    }
    .img-wrap img{display:block; width:100%; height:100%; object-fit:cover; aspect-ratio: 16/10;}

    .cta-row{display:flex; gap:12px; flex-wrap:wrap; margin-top:14px}
    .btn{
      appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:600; cursor:pointer;
      background:var(--cvu-accent); color:#111; transition:transform .15s ease, box-shadow .2s ease;
    }
    .btn.secondary{background:#0f0f0f; color:var(--cvu-text); border:1px solid rgba(255,255,255,.14)}
    .btn:hover{transform:translateY(-1px)}
    .btn:focus-visible{outline:2px solid var(--cvu-accent); outline-offset:2px}

    /* Selectable CTA tiles inside wizard */
    .tile{
      display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:12px;
      background:#0f0f0f; border:1px solid rgba(255,255,255,.14); cursor:pointer; user-select:none;
      transition:transform .15s ease, border-color .2s ease, background .2s ease;
      color: var(--cvu-text);
    }
    .tile:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.28)}
    .tile[aria-pressed="true"]{background:var(--cvu-accent); color:#111; border-color:transparent}
    .tile .box{
      width:22px; height:22px; border-radius:6px; border:2px solid rgba(255,255,255,.35); background:transparent; flex:0 0 auto;
    }
    .tile[aria-pressed="true"] .box{background:#111; border-color:#111; position:relative}
    .tile[aria-pressed="true"] .box::after{
      content:""; position:absolute; inset:3px; background:var(--cvu-accent); border-radius:4px;
    }
    .tile[aria-pressed="true"]{
      color: #111;
    }
    .tile span{ color: inherit; }

    /* Plan panel + progress */
    .plan{
      margin-top:14px; background:var(--cvu-card); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:14px;
    }
    .plan h5{margin:0 0 8px; font-size:1rem}
    .progress{
      width:100%; height:12px; border-radius:999px; background:#0f0f0f; border:1px solid rgba(255,255,255,.12); overflow:hidden;
    }
    .progress > span{display:block; height:100%; width:0%; background:var(--cvu-accent); transition:width .25s ease}
    .plan-list{margin:10px 0 0; padding:0; list-style:none}
    .plan-list li{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,.06)}
    .plan-list li:last-child{border-bottom:0}
    .rm{background:transparent; color:var(--cvu-text); border:1px solid rgba(255,255,255,.22); border-radius:8px; padding:6px 10px; cursor:pointer}

    .contact-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    .contact-grid input{
      width:100%; background:#0f0f0f; color:var(--cvu-text);
      border:1px solid rgba(255,255,255,.14); border-radius:10px; padding:10px 12px;
    }
    .contact-grid input::placeholder{color:#8a8a8a}

    /* Compare membership tiers table */
    .tiers{
      width:100%; border-collapse:separate; border-spacing:0; overflow:hidden;
      border-radius:var(--radius); background:var(--cvu-card); border:1px solid rgba(255,255,255,.08);
    }
    .tiers th,.tiers td{padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.06); vertical-align:top}
    .tiers thead th{
      position:sticky; top:0; background:#151515; z-index:2; text-align:left; font-size:.95rem
    }
    .tiers tbody tr:nth-child(odd){background:rgba(255,255,255,.02)}
    .check{font-weight:700}
    .x{opacity:.35}

    /* Tooltip */
    .tooltip{position:relative; cursor:help; border-bottom:1px dotted rgba(255,255,255,.35)}
    .tooltip .tip{
      position:absolute; left:0; bottom:calc(100% + 8px); max-width:300px;
      background:#0f0f0f; border:1px solid rgba(255,255,255,.15); border-radius:10px;
      padding:10px 12px; font-size:.9rem; color:var(--cvu-text); box-shadow:var(--shadow);
      opacity:0; transform:translateY(6px); pointer-events:none; transition:opacity .15s ease, transform .15s ease;
    }
    .tooltip:focus-within .tip, .tooltip:hover .tip{opacity:1; transform:translateY(0)}
    .sr-only{position:absolute!important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0}

    /* Modal (lightbox) */
    .backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.7);
      display:none; align-items:center; justify-content:center;
      z-index:1000; /* higher than ribbon */
    }
    .backdrop[aria-hidden="false"]{display:flex}
    .modal{
      background:var(--cvu-card); border:1px solid rgba(255,255,255,.12); border-radius:var(--radius-lg);
      width:min(1000px, 95vw); max-height:92vh; overflow:auto; box-shadow:var(--shadow);
    }
    .modal header{
      display:flex; justify-content:space-between; align-items:center; padding:18px 18px 0;
    }
    .modal .content{padding:18px}
    .close{
      background:transparent; border:1px solid rgba(255,255,255,.18); color:var(--cvu-text);
      border-radius:10px; padding:8px 12px; cursor:pointer;
    }

    /* Simple footer placeholder */
    .page-foot{padding:48px 0 64px; color:var(--cvu-muted); text-align:center; font-size:.95rem}

    /* Responsive */
    @media (max-width: 900px){
      .stage-grid{grid-template-columns:1fr; gap:18px}
      .contact-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <!-- HERO -->
  <div class="hero container">
    <div class="eyebrow">Partnerships</div>
    <h1>Engage with CVU: a single, intentional journey</h1>
    <p class="lead">
      Progress through four connected levels—<strong>Get Involved</strong>, <strong>Amplify Expertise Globally</strong>,
      <strong>Shape the Conversation</strong>, and <strong>Drive Global Impact</strong>—with clear calls to action at every step.
    </p>
    <div class="cta-row">
      <a class="btn" href="#wizard" data-open-wizard>Start journey</a>
      <a class="btn secondary" href="#tiers" data-open-tiers>Compare membership tiers</a>
    </div>
  </div>

  <!-- STICKY ECOSYSTEM RIBBON -->
  <nav class="ecosystem" aria-label="Engagement steps">
    <div class="container">
      <div class="eco-steps">
        <a class="eco-step" href="#stage-1" data-step="1"><span class="num">1</span> Get Involved</a>
        <a class="eco-step" href="#stage-2" data-step="2"><span class="num">2</span> Amplify Expertise Globally</a>
        <a class="eco-step" href="#stage-3" data-step="3"><span class="num">3</span> Shape the Conversation</a>
        <a class="eco-step" href="#stage-4" data-step="4"><span class="num">4</span> Drive Global Impact</a>
      </div>
    </div>
  </nav>

  <!-- STAGE 1 -->
  <section id="stage-1" class="stage container">
    <div class="stage-grid">
      <div class="img-wrap">
        <img alt="Conference keynote audience"
          src="https://images.unsplash.com/photo-1511578314322-379afb476865?q=80&w=1600&auto=format&fit=crop" />
      </div>
      <div>
        <h2>1) Get Involved</h2>
        <p class="subtitle">Start engaging with CVU communities, content, and programs.</p>
        <div class="card">
          <p>Become a member, subscribe to <em>Vertical Urbanism</em>, and explore competitions and awards.</p>
          <div class="cta-row">
            <a class="btn secondary" href="#wizard" data-open-wizard data-choice="involved">See my options</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- STAGE 2 -->
  <section id="stage-2" class="stage container">
    <div class="stage-grid">
      <div class="img-wrap">
        <img alt="Hands-on workshop session"
          src="https://images.unsplash.com/photo-1521737604893-d14cc237f11d?q=80&w=1600&auto=format&fit=crop" />
      </div>
      <div>
        <h2>2) Amplify Expertise Globally</h2>
        <p class="subtitle">Elevate your brand and expertise across CVU platforms and events.</p>
        <div class="card">
          <p>Sponsor conferences and competitions, earn building recognition, and advertise in <em>Vertical Urbanism</em>.</p>
          <div class="cta-row">
            <a class="btn secondary" href="#wizard" data-open-wizard data-choice="amplify">Build a plan</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- STAGE 3 -->
  <section id="stage-3" class="stage container">
    <div class="stage-grid">
      <div class="img-wrap">
        <img alt="Partners collaborating over plans"
          src="https://images.unsplash.com/photo-1551836022-d5d88e9218df?q=80&w=1600&auto=format&fit=crop" />
      </div>
      <div>
        <h2>3) Shape the Conversation</h2>
        <p class="subtitle">Co-create content and research that advances vertical urbanism.</p>
        <div class="card">
          <p>Partner on strategic programs, commission white papers, and develop <em>In Detail</em> and interactive studies.</p>
          <div class="cta-row">
            <a class="btn secondary" href="#wizard" data-open-wizard data-choice="shape">Show opportunities</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- STAGE 4 -->
  <section id="stage-4" class="stage container">
    <div class="stage-grid">
      <div class="img-wrap">
        <img alt="Executive roundtable"
          src="https://images.unsplash.com/photo-1520607162513-77705c0f0d4a?q=80&w=1600&auto=format&fit=crop" />
      </div>
      <div>
        <h2>4) Drive Global Impact</h2>
        <p class="subtitle">Invest in flagship initiatives with sector-wide influence.</p>
        <div class="card">
          <p>Co-curate technical guides and fund original CVU research that shapes policy and practice worldwide.</p>
          <div class="cta-row">
            <a class="btn secondary" href="#wizard" data-open-wizard data-choice="impact">Talk to Global Development</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Tiers Modal -->
  <div class="backdrop" id="tiers-modal" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Compare Membership Tiers">
    <div class="modal" role="document">
      <header>
        <h3 style="margin:0">Membership & Partnership Tiers</h3>
        <button class="close" type="button" data-close-tiers aria-label="Close tiers modal">Close</button>
      </header>
      <div class="content">
        <p class="subtitle">At a glance — what each tier includes. Hover <span class="tooltip" tabindex="0" aria-describedby="tip-benefits">benefits
          <span id="tip-benefits" class="tip">Summarized for quick comparison; final inclusions are customized by agreement.</span></span>
          for details.</p>

        <div style="overflow:auto">
          <table class="tiers" aria-describedby="tiers-caption">
            <caption id="tiers-caption" class="sr-only">Comparison of tiers from Silver to Platinum and Nonprofit/Government</caption>
            <thead>
              <tr>
                <th scope="col">Benefit</th>
                <th scope="col">Silver</th>
                <th scope="col">Gold</th>
                <th scope="col">Platinum</th>
                <th scope="col">Nonprofit / Gov’t</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th scope="row">InDetail access</th>
                <td class="check">Included</td><td class="check">Included</td><td class="check">Included</td><td class="check">Included</td>
              </tr>
              <tr>
                <th scope="row">Event discounts</th>
                <td class="check">Standard</td><td class="check">Enhanced</td><td class="check">Premier</td><td class="check">Premier</td>
              </tr>
              <tr>
                <th scope="row">Program participation</th>
                <td class="check">Select</td><td class="check">Multiple</td><td class="check">Bespoke</td><td class="check">Select</td>
              </tr>
              <tr>
                <th scope="row">Research collaboration</th>
                <td class="x">—</td><td class="check">Yes</td><td class="check">Flagship</td><td class="x">—</td>
              </tr>
              <tr>
                <th scope="row">Thought leadership</th>
                <td class="check">Profiles</td><td class="check">Panels &amp; Papers</td><td class="check">Global Stage</td><td class="check">Profiles</td>
              </tr>
              <tr>
                <th scope="row">Advisory councils</th>
                <td class="x">—</td><td class="check">Invite</td><td class="check">Seat</td><td class="x">—</td>
              </tr>
              <tr>
                <th scope="row">Dedicated account team</th>
                <td class="x">—</td><td class="check">Yes</td><td class="check">Executive</td><td class="x">—</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="cta-row" style="margin-top:16px">
          <a class="btn" href="#wizard" data-open-wizard>Start journey</a>
          <button class="btn secondary" type="button" data-close-tiers>Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Wizard Modal (Cart-like) -->
  <div class="backdrop" id="wizard" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Partner Journey Wizard">
    <div class="modal" role="document">
      <header>
        <h3 style="margin:0">Design Your CVU Journey</h3>
        <button class="close" type="button" data-close-modal aria-label="Close journey wizard">Close</button>
      </header>
      <div class="content">
        <!-- Category selector -->
        <div class="card" style="margin-bottom:14px">
          <p style="margin:0 0 .5rem">Choose a category to add actions to your plan:</p>
          <div class="cta-row">
            <button class="btn" data-choice="involved">Get Involved</button>
            <button class="btn" data-choice="amplify">Amplify Expertise Globally</button>
            <button class="btn" data-choice="shape">Shape the Conversation</button>
            <button class="btn" data-choice="impact">Drive Global Impact</button>
          </div>
        </div>

        <!-- Dynamic actions area -->
        <div id="actions" class="card" aria-live="polite">
          <strong>Select a category above to see actions.</strong>
          <p class="subtitle" style="margin:.35rem 0 0">Click tiles to add/remove them from your plan.</p>
        </div>

        <!-- Plan + progress + contact + email -->
        <div class="plan">
          <h5>Your Plan</h5>
          <div class="progress" aria-label="Progress"><span id="progressbar" style="width:0%"></span></div>
          <small id="progressText" class="subtitle">0 of 6 recommended actions selected</small>

          <ul id="planList" class="plan-list"></ul>

          <div class="contact-grid">
            <input id="nameInput" type="text" placeholder="Your name">
            <input id="companyInput" type="text" placeholder="Company / Organization">
            <input id="emailInput" type="email" placeholder="Your email">
            <input id="notesInput" type="text" placeholder="Notes (optional)">
          </div>

          <div class="cta-row" style="margin-top:12px">
            <button class="btn" id="composeEmail">Compose Email to CVU</button>
            <button class="btn secondary" type="button" id="clearPlan">Clear plan</button>
          </div>
        </div>

        <div class="cta-row" style="margin-top:16px">
          <a class="btn secondary" href="#tiers" data-open-tiers>Compare membership tiers</a>
          <button class="btn" type="button" data-close-modal>Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="page-foot container">© CVU — Demo page for GitHub Pages</div>

  <script>
    /* ---------------------------
       Config
    ----------------------------*/
    const JEN_EMAIL = "jhall@cvu.org";
    const RECOMMENDED_TARGET = 6; // progress target (# of actions)

    // Canonical action catalog
    const CATALOG = {
      involved: {
        title: 'Get Involved',
        actions: [
          'Become a Member',
          'Subscribe to Vertical Urbanism magazine',
          'Enter Research & Design Competitions',
          'Submit your Project to CVU Awards'
        ]
      },
      amplify: {
        title: 'Amplify Expertise Globally',
        actions: [
          'Sponsor the 2026 Global Summit & Regional Conferences',
          'Sponsor a Student Research or Design Competition',
          'Gain recognition as a Building of Distinction',
          'Advertise in Vertical Urbanism magazine'
        ]
      },
      shape: {
        title: 'Shape the Conversation',
        actions: [
          'Become a Strategic Program Partner',
          'Commission or Underwrite a White Paper',
          'Commission an In Detail Publication',
          'Commission an Interactive Study'
        ]
      },
      impact: {
        title: 'Drive Global Impact',
        actions: [
          'Underwrite and Co-curate a Co-branded Technical Guide',
          'Commission or Fund a CVU Research Paper'
        ]
      }
    };

    /* ---------------------------
       Smooth, ribbon-aware scroll
    ----------------------------*/
    function scrollToId(id){
      const el = document.querySelector(id);
      if(!el) return;
      const ribbon = document.querySelector('.ecosystem');
      const offset = ribbon ? ribbon.getBoundingClientRect().height + 12 : 0;
      const top = el.getBoundingClientRect().top + window.scrollY - offset;
      window.scrollTo({ top, behavior:'smooth' });
    }

    document.addEventListener('click', (e) => {
      const link = e.target.closest('a[href^="#stage-"], a[href="#top"]');
      if(!link) return;
      const id = link.getAttribute('href');
      if(!id || id==='#') return;
      e.preventDefault();
      history.pushState({}, '', id);
      scrollToId(id);
    });
    window.addEventListener('load', () => { if(location.hash && location.hash.startsWith('#stage-')) scrollToId(location.hash); });

    /* ---------------------------
       Accessible modal controller
    ----------------------------*/
    let __suppressHistoryPop = false;

    function openModal(sel){
      const backdrop = document.querySelector(sel);
      if(!backdrop) return;
      const modal = backdrop.querySelector('.modal');
      backdrop.style.display='flex';
      backdrop.setAttribute('aria-hidden','false');
      document.body.style.overflow='hidden';

      const focusables = modal.querySelectorAll('a,button,input,select,textarea,[tabindex]:not([tabindex="-1"])');
      const first = focusables[0] || modal;
      const last  = focusables[focusables.length-1] || modal;
      const opener = document.activeElement;
      backdrop.dataset.returnSelector = opener ? (() => {
        const uid = 'ret-' + Math.random().toString(36).slice(2);
        opener.setAttribute('data-ret', uid);
        return `[data-ret="${uid}"]`;
      })() : '';

      first.focus();

      function trap(e){
        if(e.key === 'Escape'){ e.preventDefault(); closeModal(sel); return; }
        if(e.key !== 'Tab' || !focusables.length) return;
        if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
        else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
      }
      backdrop._trap = trap;
      backdrop.addEventListener('keydown', trap);
    }

    function closeModal(sel){
      const backdrop = document.querySelector(sel);
      if(!backdrop) return;
      backdrop.setAttribute('aria-hidden','true');
      backdrop.style.display='none';
      document.body.style.overflow='';
      const retSel = backdrop.dataset.returnSelector;
      if(retSel){
        const opener = document.querySelector(retSel);
        if(opener){ opener.focus(); opener.removeAttribute('data-ret'); }
        backdrop.dataset.returnSelector='';
      }
      if(backdrop._trap){ backdrop.removeEventListener('keydown', backdrop._trap); delete backdrop._trap; }

      if(!__suppressHistoryPop && (location.hash === '#wizard' || location.hash.startsWith('#wizard?') || location.hash === '#tiers')){
        history.back();
      }
    }

    // Backdrop click to close (click outside the modal)
    document.getElementById('wizard')?.addEventListener('click', (e)=>{ if(e.target.id==='wizard') closeModal('#wizard');});
    document.getElementById('tiers-modal')?.addEventListener('click', (e)=>{ if(e.target.id==='tiers-modal') closeModal('#tiers-modal');});

    // Close buttons
    document.querySelectorAll('[data-close-modal]').forEach(b=>b.addEventListener('click',()=>closeModal('#wizard')));
    document.querySelectorAll('[data-close-tiers]').forEach(b=>b.addEventListener('click',()=>closeModal('#tiers-modal')));

    /* ---------------------------
       Hash router for deep links
    ----------------------------*/
    const routes = {
      '#wizard': () => openModal('#wizard'),
      '#tiers' : () => openModal('#tiers-modal'),
      '#stage-1': () => scrollToId('#stage-1'),
      '#stage-2': () => scrollToId('#stage-2'),
      '#stage-3': () => scrollToId('#stage-3'),
      '#stage-4': () => scrollToId('#stage-4'),
    };
    function handleHash(){
      const [path, query] = location.hash.split('?');
      if(routes[path]) routes[path]();
      const params = new URLSearchParams(query || '');
      const goal = params.get('goal');
      if(goal) setCategory(goal);
    }
    window.addEventListener('hashchange', handleHash);
    window.addEventListener('load', handleHash);

    // Openers write hash
    document.querySelectorAll('[data-open-wizard]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.preventDefault();
        const choice = btn.getAttribute('data-choice');
        const q = choice ? `?goal=${encodeURIComponent(choice)}` : '';
        location.hash = '#wizard' + q;
      });
    });
    document.querySelectorAll('[data-open-tiers]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{ e.preventDefault(); location.hash = '#tiers'; });
    });

    /* ---------------------------
       Eco ribbon highlight
    ----------------------------*/
    const stepLinks = [...document.querySelectorAll('.eco-step')];
    const map = {'stage-1':1,'stage-2':2,'stage-3':3,'stage-4':4};
    const io = new IntersectionObserver((entries)=>{
      for(const en of entries){
        if(en.isIntersecting){
          const i = map[en.target.id];
          stepLinks.forEach(l => l.classList.toggle('active', Number(l.dataset.step)===i));
        }
      }
    }, {rootMargin:'-45% 0px -50% 0px', threshold:0.01});
    ['stage-1','stage-2','stage-3','stage-4'].forEach(id => { const el = document.getElementById(id); if(el) io.observe(el); });

    /* ---------------------------
       Cart-like plan state
    ----------------------------*/
    const actionsEl = document.getElementById('actions');
    const planList = document.getElementById('planList');
    const progressBar = document.getElementById('progressbar');
    const progressText = document.getElementById('progressText');
    const composeBtn = document.getElementById('composeEmail');
    const clearBtn = document.getElementById('clearPlan');

    const nameInput = document.getElementById('nameInput');
    const companyInput = document.getElementById('companyInput');
    const emailInput = document.getElementById('emailInput');
    const notesInput = document.getElementById('notesInput');

    // Structure: { categoryKey: Set([actionLabel, ...]) }
    const plan = loadPlan();

    function loadPlan(){
      try{
        const raw = localStorage.getItem('cvu_plan_v1');
        return raw ? revive(JSON.parse(raw)) : {};
      }catch(e){ return {}; }
    }
    function savePlan(){
      localStorage.setItem('cvu_plan_v1', JSON.stringify(dehydrate(plan)));
    }
    function dehydrate(obj){
      const out = {};
      for(const k in obj){ out[k] = Array.from(obj[k]); }
      return out;
    }
    function revive(json){
      const out = {};
      for(const k in json){ out[k] = new Set(json[k]); }
      return out;
    }

    function setCategory(key){
      const cfg = CATALOG[key];
      if(!cfg){ actionsEl.innerHTML = `<strong>Unknown category.</strong>`; return; }

      // Render tiles
      actionsEl.innerHTML = `
        <h4 style="margin:0 0 .35rem">${cfg.title}</h4>
        <div class="cta-row" style="margin-top:6px; flex-direction:column; align-items:stretch">
          ${cfg.actions.map(label => {
            const active = plan[key]?.has(label) ? 'true' : 'false';
            return `
              <button class="tile" data-key="${key}" data-label="${label}" aria-pressed="${active}">
                <span class="box" aria-hidden="true"></span>
                <span>${label}</span>
              </button>
            `;
          }).join('')}
        </div>
      `;
      // Wire toggles
      actionsEl.querySelectorAll('.tile').forEach(tile=>{
        tile.addEventListener('click', ()=>{
          const k = tile.getAttribute('data-key');
          const lbl = tile.getAttribute('data-label');
          toggleItem(k, lbl);
          tile.setAttribute('aria-pressed', plan[k]?.has(lbl) ? 'true' : 'false');
        });
      });

      renderPlan();
    }

    function toggleItem(category, label){
      if(!plan[category]) plan[category] = new Set();
      if(plan[category].has(label)) plan[category].delete(label);
      else plan[category].add(label);
      if(plan[category].size === 0) delete plan[category];
      savePlan();
      renderPlan();
    }

    function renderPlan(){
      // Build list
      const items = [];
      for(const k in plan){
        for(const label of plan[k]){
          items.push({category:k, label});
        }
      }
      // Progress
      const pct = Math.min(100, Math.round((items.length / RECOMMENDED_TARGET) * 100));
      progressBar.style.width = pct + '%';
      progressText.textContent = `${items.length} of ${RECOMMENDED_TARGET} recommended actions selected`;

      // Render grouped list
      const groups = {};
      items.forEach(it => {
        const title = CATALOG[it.category]?.title || it.category;
        if(!groups[title]) groups[title] = [];
        groups[title].push(it);
      });

      const html = Object.keys(groups).length === 0
        ? `<li><em>No actions selected yet.</em></li>`
        : Object.entries(groups).map(([title, arr]) => {
            return `
              <li style="display:block; border:none; padding:0 0 6px;">
                <strong>${title}</strong>
              </li>
              ${arr.map(it => `
                <li>
                  <span>${it.label}</span>
                  <button class="rm" data-k="${it.category}" data-l="${it.label}">Remove</button>
                </li>
              `).join('')}
            `;
          }).join('');

      planList.innerHTML = html;

      planList.querySelectorAll('.rm').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          toggleItem(btn.getAttribute('data-k'), btn.getAttribute('data-l'));
          // Also un-press tile if visible
          const tile = actionsEl.querySelector(`.tile[data-key="${btn.getAttribute('data-k')}"][data-label="${btn.getAttribute('data-l')}"]`);
          if(tile) tile.setAttribute('aria-pressed','false');
        });
      });
    }

    clearBtn.addEventListener('click', ()=>{
      for(const k in plan){ delete plan[k]; }
      savePlan();
      renderPlan();
      // Reset any visible tiles
      actionsEl.querySelectorAll('.tile[aria-pressed="true"]').forEach(t => t.setAttribute('aria-pressed','false'));
    });

    // Compose email
    composeBtn.addEventListener('click', ()=>{
      const name = (nameInput.value || '').trim();
      const company = (companyInput.value || '').trim();
      const email = (emailInput.value || '').trim();
      const notes = (notesInput.value || '').trim();

      const lines = [];
      lines.push(`Hello Jen,`);
      lines.push('');
      lines.push(`I'd like to discuss a tailored CVU engagement plan:`);

      for(const k in plan){
        const title = CATALOG[k]?.title || k;
        lines.push('');
        lines.push(`- ${title}:`);
        for(const label of plan[k]){
          lines.push(`   • ${label}`);
        }
      }

      lines.push('');
      if(company) lines.push(`Company: ${company}`);
      if(name) lines.push(`Contact: ${name}`);
      if(email) lines.push(`Email: ${email}`);
      if(notes) { lines.push(''); lines.push(`Notes: ${notes}`); }
      lines.push('');
      lines.push('Thank you!');

      const subject = `CVU Journey Plan${name ? ' — ' + name : ''}`;
      const body = lines.join('\n');

      const href = `mailto:${encodeURIComponent(JEN_EMAIL)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      // Open mail client
      window.location.href = href;
    });

    // Category buttons in wizard
    document.querySelectorAll('#wizard [data-choice]').forEach(b=>{
      b.addEventListener('click', ()=>{ setCategory(b.getAttribute('data-choice')); });
    });

    // On load, prime plan UI & restore last viewed category (default to involved)
    renderPlan();

    /* ---------------------------
       Helper: close modals then go
    ----------------------------*/
    function closeAllModalsAndGo(id){
      __suppressHistoryPop = true;
      const wiz = document.getElementById('wizard');
      const tiers = document.getElementById('tiers-modal');
      if (wiz && wiz.getAttribute('aria-hidden') === 'false') closeModal('#wizard');
      if (tiers && tiers.getAttribute('aria-hidden') === 'false') closeModal('#tiers-modal');
      __suppressHistoryPop = false;
      history.pushState({}, '', id);
      scrollToId(id);
    }

    // Delegate close-first-then-scroll for any stage links inside modals
    document.querySelectorAll('.backdrop').forEach(backdrop => {
      backdrop.addEventListener('click', (e) => {
        const a = e.target.closest('a[href^="#stage-"]');
        if (!a) return;
        e.preventDefault();
        closeAllModalsAndGo(a.getAttribute('href'));
      });
    });
  </script>
</body>
</html>
